<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Deal or No Deal" />
  <link rel="apple-touch-icon" href="touch-icon.png" />
  <title>Deal or No Deal â€” Polished Edition</title>
  <style>
    :root {
      --bg1:#041328; --bg2:#00335a; --bg3:#0060a1; --gold1:#ffd700; --gold2:#ffdf80;
    }
    * {
      box-sizing:border-box;
      font-family:Poppins,Inter,system-ui,-apple-system,'Segoe UI',Roboto,Arial,sans-serif;
      -webkit-tap-highlight-color: transparent;
    }
    html, body {
      height:100%;
      margin:0;
      padding:0;
      background: linear-gradient(120deg, var(--bg1), var(--bg2), var(--bg3));
      background-size:300% 300%;
      animation: shiftBg 18s ease-in-out infinite;
      color: #eef8ff;
      padding-top: env(safe-area-inset-top);
      padding-bottom: env(safe-area-inset-bottom);
      padding-left: env(safe-area-inset-left);
      padding-right: env(safe-area-inset-right);
    }
    @keyframes shiftBg {
      0% { background-position:0% 50%; }
      50% { background-position:100% 50%; }
      100% { background-position:0% 50%; }
    }
    .wrap {
      width:1180px;
      max-width:98%;
      margin:18px auto;
      padding:18px 0;
    }
    header {
      display:flex;
      align-items:center;
      justify-content:center;
      margin-bottom:12px;
    }
    h1.title {
      font-size:36px;
      color:var(--gold1);
      margin:0;
      font-weight:900;
    }
    #soundToggle {
      position:fixed;
      right:18px;
      top:18px;
      background:linear-gradient(145deg, var(--gold1), var(--gold2));
      color:#001;
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      z-index:100;
      touch-action: manipulation;
    }
    .stage {
      display:flex;
      gap:18px;
      align-items:flex-start;
      justify-content:center;
      flex-wrap:wrap;
    }
    .sideboard {
      width:260px;
      max-width:100%;
      background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));
      padding:12px;
      border-radius:12px;
    }
    .sideboard h3 {
      margin:4px 0 10px 0;
      color:var(--gold2);
    }
    .prize {
      display:flex;
      justify-content:space-between;
      padding:8px;
      border-radius:8px;
      margin-bottom:6px;
      font-weight:800;
      font-size:14px;
    }
    .prize.elim {
      opacity:0.45;
      text-decoration:line-through;
      color:#ff9e9e;
    }
    .center {
      flex:1;
      display:flex;
      flex-direction:column;
      align-items:center;
      min-width:300px;
    }
    .stage-area {
      width:780px;
      max-width:100%;
      background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      padding:16px;
      border-radius:12px;
      position:relative;
    }
    .spotlight {
      position:absolute;
      inset:0;
      pointer-events:none;
    }
    .beam {
      position:absolute;
      left:-40%;
      top:-20%;
      width:180%;
      height:160%;
      background: radial-gradient(400px 200px at 50% 20%, rgba(255,255,255,0.18), rgba(255,255,255,0.02) 20%, rgba(255,255,255,0) 50%);
      transform: rotate(-18deg);
      filter: blur(12px);
      animation: beamMove 6s linear infinite;
    }
    @keyframes beamMove {
      0%   { transform: translateX(-30%) rotate(-12deg); }
      50%  { transform: translateX(30%) rotate(6deg);  }
      100% { transform: translateX(-30%) rotate(-12deg); }
    }
    /* Fix for iOS grid issues: ensure container not a flex parent causing grid to collapse */
    #cases {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(90px, 1fr));
      gap:12px;
      overflow-anchor: none; /* iOS grid bug fix */  /* :contentReference[oaicite:0]{index=0} */
      grid-auto-rows: minmax(0, auto);  /* help avoid iOS collapse issues */  /* :contentReference[oaicite:1]{index=1} */
      position: relative;
    }
    .case {
      height:90px;
      perspective:1000px;
      position:relative;
      touch-action: manipulation;
    }
    .inner {
      width:100%;
      height:100%;
      position:relative;
      transform-style:preserve-3d;
      transition:transform 0.9s ease-in-out;
    }
    .case.flipped .inner {
      transform:rotateY(180deg);
    }
    .face {
      position:absolute;
      inset:0;
      border-radius:8px;
      display:flex;
      align-items:center;
      justify-content:center;
      backface-visibility:hidden;
      font-size:14px;
    }
    .front {
      background: linear-gradient(145deg, #2f4f6f, #223849);
      color: #e6f8ff;
      font-weight:800;
    }
    .back {
      transform:rotateY(180deg);
      background: linear-gradient(145deg, #0c2a42, #07203a);
      color: var(--gold2);
      font-weight:900;
    }
    .glow {
      position:absolute;
      inset:-4px;
      border-radius:10px;
      pointer-events:none;
      transition: box-shadow .25s;
    }
    .case:hover .glow {
      box-shadow:0 0 22px rgba(255,200,60,0.5);
    }
    .burst {
      position:absolute;
      left:50%;
      top:50%;
      transform:translate(-50%,-50%) scale(0);
      width:160px; height:160px;
      border-radius:50%;
      background: radial-gradient(circle at center, rgba(255,230,150,0.95), rgba(255,200,60,0.12) 35%, rgba(255,200,60,0) 55%);
      opacity:0;
      pointer-events:none;
    }
    .reveal .burst {
      animation: burstAnim 700ms ease-out forwards;
    }
    @keyframes burstAnim {
      0%   { transform:translate(-50%,-50%) scale(.2); opacity:1; }
      60%  { transform:translate(-50%,-50%) scale(1.05); opacity:0.9; }
      100% { transform:translate(-50%,-50%) scale(1.6); opacity:0; }
    }
    #overlay {
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      z-index:100;
    }
    #overlay.show {
      display:flex;
      background: rgba(0,0,0,0.6);
    }
    #bankerCard {
      width:520px;
      max-width:90%;
      background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));
      backdrop-filter: blur(6px);
      padding:18px;
      border-radius:12px;
      transform:translateY(-12px);
      opacity:0;
      transition: all .32s ease;
    }
    #bankerCard.show {
      transform: translateY(0);
      opacity:1;
    }
    #bankerAmt {
      font-size:34px;
      color: var(--gold1);
      font-weight:900;
    }
    .banker-actions {
      display:flex;
      gap:12px;
      justify-content:center;
      margin-top:10px;
      flex-wrap:wrap;
    }
    .btn {
      padding:12px 16px;
      border-radius:8px;
      cursor:pointer;
      font-weight:800;
      touch-action: manipulation;
    }
    .btn.deal {
      background: linear-gradient(145deg, var(--gold1), var(--gold2));
      color:#001;
    }
    .btn.nodeal {
      background:transparent;
      border:1px solid rgba(255,255,255,0.08);
      color:#eaf6ff;
    }
    .final-overlay {
      position: fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      z-index:150;
      background: rgba(0,0,0,0.65);
      backdrop-filter: blur(4px);
      animation: fadeInFinal 0.6s ease forwards;
    }
    .final-overlay.show {
      display:flex;
    }
    .final-card {
      background: linear-gradient(180deg, rgba(0,0,0,0.6), rgba(0,0,0,0.4));
      padding:28px 34px;
      border-radius:14px;
      text-align:center;
      box-shadow:0 0 32px rgba(255,215,0,0.2);
      max-width:90%;
    }
    .congrats {
      font-size:42px;
      color: var(--gold1);
      font-weight:900;
      text-shadow:0 0 12px rgba(255,215,0,0.4);
    }
    @keyframes fadeInFinal { from { opacity:0 } to { opacity:1 } }
    .info-panel {
      width:220px;
      max-width:90%;
      background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));
      border-radius:12px;
      padding:14px;
    }
    .info-panel h3 { margin:0 0 10px 0; color: var(--gold2); }
    .info-item { margin-bottom:10px; font-weight:700; }
    .info-value { color: var(--gold1); font-size:20px; font-weight:900; }
    .playAgain {
      margin-top:12px;
      padding:12px 16px;
      border:none;
      border-radius:8px;
      background: linear-gradient(145deg, var(--gold1), var(--gold2));
      cursor:pointer;
      font-weight:800;
      touch-action: manipulation;
    }
    canvas.confetti {
      position:fixed;
      inset:0;
      pointer-events:none;
      z-index:200;
    }
    footer {
      text-align:center;
      margin-top:12px;
      color: rgba(234,246,255,0.7);
      font-size:14px;
    }
  </style>
</head>
<body>
  <div id="soundToggle">ðŸ”Š</div>
  <div class="wrap">
    <header><h1 class="title">Deal or No Deal</h1></header>

    <div class="stage">
      <aside class="sideboard">
        <h3>Prize Board</h3>
        <div id="prize-list"></div>
      </aside>

      <section class="center">
        <div class="stage-area">
          <div class="spotlight"><div class="beam"></div></div>
          <div id="cases"></div>
          <div id="offerArea" style="text-align:center;margin-top:14px"></div>
          <div class="final-overlay" id="finalOverlay"><div class="final-card" id="finalCard"></div></div>
        </div>
      </section>

      <aside class="info-panel">
        <h3>Game Info</h3>
        <div class="info-item">Your Case: <div id="yourCase" class="info-value">â€”</div></div>
        <div class="info-item">Cases Left: <div id="casesLeft" class="info-value">23</div></div>
      </aside>
    </div>

    <footer>Enhanced edition â€¢ Cinematic finale â€¢ Live case tracker</footer>
  </div>

  <div id="overlay"><div id="bankerCard"><div style="font-size:14px;color:rgba(234,246,255,0.8)">The banker is calling...</div><div id="bankerAmt">â‚±0</div><div class="banker-actions"><button class="btn deal" id="acceptBtn">Deal</button><button class="btn nodeal" id="rejectBtn">No Deal</button></div></div></div>
  <canvas class="confetti" id="confettiCanvas"></canvas>

  <script>
    const PRIZES = [5000,4800,4500,4200,4000,3800,3500,3200,3000,2800,2500,2200,2000,1800,1500,1200,1000,800,500,300,3,2,1];
    const TOTAL = PRIZES.length;
    const OFFER_INTERVAL = 3;

    let shuffled = [], opened = new Set(), playerCase = null, offers = [], soundOn = true;

    const yourCaseEl = document.getElementById('yourCase');
    const casesLeftEl = document.getElementById('casesLeft');
    const casesEl = document.getElementById('cases');
    const prizeListEl = document.getElementById('prize-list');
    const offerArea = document.getElementById('offerArea');
    const overlay = document.getElementById('overlay');
    const bankerCard = document.getElementById('bankerCard');
    const bankerAmt = document.getElementById('bankerAmt');
    const acceptBtn = document.getElementById('acceptBtn');
    const rejectBtn = document.getElementById('rejectBtn');
    const finalOverlay = document.getElementById('finalOverlay');
    const finalCard = document.getElementById('finalCard');
    const confettiCanvas = document.getElementById('confettiCanvas');
    const soundToggle = document.getElementById('soundToggle');

    const AudioCtx = window.AudioContext || window.webkitAudioContext;
    let audioCtx;
    function ensureAudio(){ if(!audioCtx) audioCtx = new AudioCtx(); }
    function playClick(){ if(!soundOn) return; ensureAudio(); const o = audioCtx.createOscillator(), g = audioCtx.createGain(); o.type='square'; o.frequency.value=900; g.gain.value=0.002; o.connect(g); g.connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime + 0.06); }
    function playChing(){ if(!soundOn) return; ensureAudio(); const o = audioCtx.createOscillator(), g = audioCtx.createGain(); o.type='triangle'; o.frequency.value=880; g.gain.value=0.004; o.connect(g); g.connect(audioCtx.destination); o.start(); o.frequency.exponentialRampToValueAtTime(1320,audioCtx.currentTime+0.18); g.gain.exponentialRampToValueAtTime(0.0001,audioCtx.currentTime+0.35); o.stop(audioCtx.currentTime + 0.5); }
    function playRing(){ if(!soundOn) return; ensureAudio(); const o1 = audioCtx.createOscillator(), o2 = audioCtx.createOscillator(), g = audioCtx.createGain(); o1.type='sine'; o2.type='sine'; o1.frequency.value=600; o2.frequency.value=780; g.gain.value = 0.0035; o1.connect(g); o2.connect(g); g.connect(audioCtx.destination); const t = audioCtx.currentTime; o1.start(t); o2.start(t); o1.stop(t+0.5); o2.stop(t+0.5); }
    function playDrumRoll(duration=3){ if(!soundOn) return; ensureAudio(); const bufferSize = audioCtx.sampleRate * duration; const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate); const data = buffer.getChannelData(0); for(let i=0;i<bufferSize;i++){ data[i] = (Math.random()*2-1) * (1 - i/bufferSize); } const src = audioCtx.createBufferSource(); src.buffer = buffer; const f = audioCtx.createBiquadFilter(); f.type='lowpass'; f.frequency.value = 1200; const g = audioCtx.createGain(); g.gain.value = 0.002; src.connect(f); f.connect(g); g.connect(audioCtx.destination); src.start(); src.stop(audioCtx.currentTime + duration); }

    const ctx = confettiCanvas.getContext('2d');
    function resizeCanvas(){ confettiCanvas.width = window.innerWidth; confettiCanvas.height = window.innerHeight; }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();
    let confettiPieces = [];
    function startConfetti(){
      confettiPieces = [];
      const colors = ['#ffd166','#ffb84d','#fff3b0','#ffd700','#ffffff'];
      for(let i=0;i<160;i++){
        confettiPieces.push({
          x:Math.random()*confettiCanvas.width,
          y:-Math.random()*confettiCanvas.height,
          vx:(Math.random()-0.5)*4,
          vy:2+Math.random()*6,
          size:6+Math.random()*10,
          color:colors[Math.floor(Math.random()*colors.length)],
          rot:Math.random()*360,
          rotSpeed:(Math.random()-0.5)*8
        });
      }
      requestAnimationFrame(renderConfetti);
    }
    function renderConfetti(){
      ctx.clearRect(0,0,confettiCanvas.width,confettiCanvas.height);
      confettiPieces.forEach(p=>{
        p.x += p.vx; p.y += p.vy; p.rot += p.rotSpeed;
        ctx.save();
        ctx.translate(p.x,p.y);
        ctx.rotate(p.rot * Math.PI/180);
        ctx.fillStyle = p.color;
        ctx.fillRect(-p.size/2, -p.size/2, p.size, p.size*0.6);
        ctx.restore();
      });
      confettiPieces = confettiPieces.filter(p=>p.y < confettiCanvas.height + 50);
      if(confettiPieces.length>0) requestAnimationFrame(renderConfetti);
    }

    function delay(ms){ return new Promise(res=>setTimeout(res, ms)); }

    function init(){
      shuffled = PRIZES.slice().sort(()=>Math.random()-0.5);
      opened.clear();
      playerCase = null;
      offers = [];
      yourCaseEl.textContent = 'â€”';
      casesLeftEl.textContent = TOTAL;
      renderPrizeBoard();
      renderCases();
    }

    function renderPrizeBoard(){
      prizeListEl.innerHTML = '';
      PRIZES.slice().sort((a,b)=>b-a).forEach(v=>{
        const d = document.createElement('div');
        d.className = 'prize';
        d.id = `prize-${v}`;
        d.innerHTML = `<div>â‚±${v.toLocaleString()}</div>`;
        prizeListEl.appendChild(d);
      });
    }

    function renderCases(){
      casesEl.innerHTML = '';
      for(let i=0;i<TOTAL;i++){
        const div = document.createElement('div');
        div.className='case';
        div.dataset.index = i;
        div.innerHTML = `<div class='inner'><div class='face front'>Case ${i+1}</div><div class='face back'>â‚±${shuffled[i].toLocaleString()}</div></div><div class='glow'></div><div class='burst'></div>`;
        div.addEventListener('click', ()=>handleCaseClick(i));
        casesEl.appendChild(div);
      }
    }

    function handleCaseClick(i){
      if(overlay.classList.contains('show')) return;
      if(playerCase === null){
        playerCase = i;
        yourCaseEl.textContent = i+1;
        playClick();
        const node = document.querySelectorAll('.case')[i];
        node.querySelector('.glow').style.boxShadow='0 0 30px rgba(255,215,90,0.5)';
        setTimeout(()=>{ node.querySelector('.glow').style.boxShadow=''; }, 900);
        updateUI();
        return;
      }
      if(i === playerCase || opened.has(i)) return;
      opened.add(i);
      const node = document.querySelectorAll('.case')[i];
      node.classList.add('flipped','reveal');
      playChing();
      setTimeout(()=> node.classList.remove('reveal'), 900);
      const val = shuffled[i];
      const pEl = document.getElementById(`prize-${val}`);
      if(pEl) pEl.classList.add('elim');
      updateUI();

      const nonPlayerOpened = [...opened].filter(idx => idx!==playerCase).length;
      if(nonPlayerOpened>0 && nonPlayerOpened % OFFER_INTERVAL === 0){
        setTimeout(()=> showBankerOffer(), 700);
      }

      const unopenedExclPlayer = [...Array(TOTAL).keys()].filter(i0=>!opened.has(i0) && i0!==playerCase).length;
      casesLeftEl.textContent = unopenedExclPlayer;
      if(unopenedExclPlayer===0){
        setTimeout(()=> triggerFinale(), 900);
      }
    }

    function updateUI(){
      const unopenedExclPlayer = [...Array(TOTAL).keys()].filter(i0=>!opened.has(i0) && i0!==playerCase).length;
      casesLeftEl.textContent = unopenedExclPlayer;
    }

    function computeOffer(){
      const remaining=[];
      for(let i=0;i<TOTAL;i++) if(!opened.has(i)) remaining.push(shuffled[i]);
      const avg = remaining.reduce((a,b)=>a+b,0)/remaining.length;
      const openedCount=[...opened].filter(i=>i!==playerCase).length;
      const tiers=[0.35,0.4,0.45,0.55,0.65,0.75,0.85,0.95];
      const mult = tiers[Math.min(Math.floor(openedCount/2), tiers.length-1)];
      const offer = Math.round((avg*mult)/10)*10;
      return offer;
    }

    function showBankerOffer(){
      const offer = computeOffer();
      offers.push(offer);
      bankerAmt.textContent = `â‚±${offer.toLocaleString()}`;
      overlay.classList.add('show');
      bankerCard.classList.add('show');
      playRing();
      offerArea.innerHTML = `<div style="display:inline-block;padding:12px 16px;border-radius:12px;background:rgba(255,255,255,0.02);font-weight:900">Banker: <span style='color:${'var(--gold2)'}'>â‚±${offer.toLocaleString()}</span></div>`;
    }

    acceptBtn.addEventListener('click', ()=>{
      playClick();
      const last = offers[offers.length-1];
      revealAfterDeal(last);
      hideBanker();
    });
    rejectBtn.addEventListener('click', ()=>{
      playClick();
      hideBanker();
    });

    function hideBanker(){
      bankerCard.classList.remove('show');
      setTimeout(()=> overlay.classList.remove('show'), 300);
    }

    function revealAfterDeal(dealAmt){
      const node = document.querySelectorAll('.case')[playerCase];
      node.classList.add('flipped');
      playChing();
      const val = shuffled[playerCase];
      const pEl = document.getElementById(`prize-${val}`);
      if(pEl) pEl.classList.add('elim');
      offerArea.innerHTML = `<div style='padding:12px 14px;border-radius:10px;background:rgba(255,255,255,0.02);font-weight:900'>You accepted â‚±${dealAmt.toLocaleString()} â€” your case had â‚±${val.toLocaleString()}.</div>`;
      document.querySelectorAll('.case').forEach(c=>c.style.pointerEvents='none');
    }

    async function triggerFinale(){
      document.querySelectorAll('.case').forEach((c, idx)=>{
        if(idx!==playerCase){
          c.style.transition='opacity 700ms ease-in-out';
          c.style.opacity=0.18;
        }
      });
      const playerNode = document.querySelectorAll('.case')[playerCase];
      playerNode.style.zIndex = 60;
      playerNode.querySelector('.glow').style.boxShadow='0 0 36px rgba(255,215,90,0.95)';
      finalOverlay.classList.add('show');
      finalCard.innerHTML = `<div style='color:rgba(234,246,255,0.9);font-weight:700;margin-bottom:10px'>And here's whatâ€™s in your caseâ€¦</div>`;
      playDrumRoll(3.2);
      await delay(2400);
      playerNode.classList.add('flipped');
      playChing();
      await delay(1400);
      const val = shuffled[playerCase];
      finalCard.innerHTML = `<div class='congrats'>Congratulations!</div><div style='font-size:42px;color:var(--gold1);font-weight:900;marginâ€‘top:8px'>â‚±${val.toLocaleString()}</div><button class='playAgain' onclick='restartGame()'>Play Again</button>`;
      startConfetti();
      document.querySelectorAll('.case').forEach(c=>c.style.pointerEvents='none');
      const pEl=document.getElementById(`prize-${val}`);
      if(pEl) pEl.classList.add('elim');
    }

    function restartGame(){
      confettiPieces = [];
      ctx.clearRect(0,0,confettiCanvas.width, confettiCanvas.height);
      finalOverlay.classList.remove('show');
      document.querySelectorAll('.case').forEach(c=>{
        c.style.opacity='';
        c.style.zIndex='';
        c.classList.remove('flipped');
        c.style.pointerEvents='auto';
        c.querySelector('.glow').style.boxShadow='';
      });
      PRIZES.forEach(v=>{
        const e = document.getElementById(`prize-${v}`);
        if(e) e.classList.remove('elim');
      });
      overlay.classList.remove('show');
      bankerCard.classList.remove('show');
      offerArea.innerHTML='';
      init();
    }

    soundToggle.addEventListener('click', ()=>{
      soundOn = !soundOn;
      soundToggle.textContent = soundOn ? 'ðŸ”Š' : 'ðŸ”‡';
    });

    init();
  </script>
</body>
</html>
